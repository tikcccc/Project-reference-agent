<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jarvisé¹°çœ¼ - AIé¡¹ç›®åŒ¹é…æµç¨‹åŸå‹ (åŠŸèƒ½å¢å¼ºç‰ˆ)</title>
    <style>
        /* General Styling */
        :root {
            --primary-color: #2a6ee3;
            --secondary-color: #6c757d;
            --border-color: #e0e0e0;
            --bg-color: #f4f5f7;
            --text-color: #333;
            --text-light: #888;
            --card-bg: #fff;
            --font-family: 'Helvetica Neue', Helvetica, 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', 'å¾®è½¯é›…é»‘', Arial, sans-serif;
        }
        body {
            margin: 0;
            font-family: var(--font-family);
            background-color: var(--bg-color);
            color: var(--text-color);
            font-size: 14px;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        /* App Layout */
        .app-container { display: flex; height: 100vh; overflow: hidden; }
        .sidebar { width: 280px; background-color: var(--card-bg); border-right: 1px solid var(--border-color); padding: 0; box-sizing: border-box; display: flex; flex-direction: column; flex-shrink: 0; }
        .sidebar-header { font-size: 18px; margin: 0; display: flex; align-items: center; padding: 16px; border-bottom: 1px solid var(--border-color); font-weight: 600; }
        .sidebar-header img { width: 24px; margin-right: 10px; }
        .sidebar-content { padding: 16px; flex: 1; overflow-y: auto; }
        .new-analysis-btn { width: 100%; background-color: var(--primary-color); color: white; border: none; padding: 12px 16px; border-radius: 6px; font-size: 14px; cursor: pointer; margin-bottom: 16px; transition: background-color 0.3s; font-weight: 500; }
        .new-analysis-btn:hover { background-color: #205ac8; }
        .history-list h3 { font-size: 13px; color: var(--text-light); margin: 16px 0 12px 0; font-weight: 500; text-transform: uppercase; }
        .history-list ul { list-style: none; padding: 0; margin: 0; }
        .history-list li { padding: 12px; border-radius: 6px; cursor: pointer; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; transition: background-color 0.3s, color 0.3s; font-size: 14px; line-height: 1.4; }
        .history-list li:hover { background-color: #f8f9fa; }
        .history-list li.active { background-color: #eaf1fd; color: var(--primary-color); font-weight: 600; }
        .main-content { flex-grow: 1; padding: 24px; overflow-y: auto; }
        .page { display: none; }
        .page.active { display: block; animation: fadeIn 0.5s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* Page Headers & Controls */
        .page-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; }
        .page-header h1 { font-size: 24px; margin: 0; font-weight: 600; }
        .header-title-toolbar { display: flex; align-items: center; gap: 24px; }
        .toolbar { display: flex; align-items: center; gap: 16px; }
        .toolbar a { color: var(--primary-color); text-decoration: none; font-size: 14px; cursor: pointer; }
        .toolbar a:hover { text-decoration: underline; }
        .header-actions { display: flex; gap: 12px; position: relative; }
        .action-btn, .secondary-btn { background-color: var(--primary-color); color: white; border: 1px solid var(--primary-color); padding: 10px 20px; border-radius: 6px; font-size: 14px; cursor: pointer; transition: all 0.3s; font-weight: 500; }
        .secondary-btn { background-color: transparent; color: var(--secondary-color); border: 1px solid #ccc; }
        .action-btn:hover:not(:disabled) { background-color: #205ac8; border-color: #205ac8; }
        .secondary-btn:hover { background-color: #f0f0f0; }
        .action-btn:disabled { background-color: #b0c4de; border-color: #b0c4de; cursor: not-allowed; }
        .dropdown-menu { position: absolute; top: 100%; right: 0; background-color: white; border: 1px solid var(--border-color); border-radius: 6px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); z-index: 10; overflow: hidden; margin-top: 8px; }
        .dropdown-menu a { display: block; padding: 10px 20px; color: var(--text-color); text-decoration: none; }
        .dropdown-menu a:hover { background-color: #f0f0f0; }

        /* Breadcrumb */
        .breadcrumb-container { margin-bottom: 24px; font-size: 14px; }
        .breadcrumb-item { color: var(--primary-color); text-decoration: none; cursor: pointer; }
        .breadcrumb-item:hover { text-decoration: underline; }
        .breadcrumb-item.active { color: var(--text-color); font-weight: bold; pointer-events: none; }
        .breadcrumb-separator { margin: 0 8px; color: var(--text-light); }

        /* Step 0: Upload Page */
        .upload-page-container { max-width: 800px; margin: 40px auto; text-align: center; }
        .upload-page-container h1 { font-size: 28px; margin-bottom: 12px; font-weight: 600; }
        .upload-page-container p { color: var(--text-light); margin-bottom: 40px; font-size: 16px; line-height: 1.5; }
        .upload-box { border: 2px dashed var(--border-color); border-radius: 8px; padding: 40px; margin-bottom: 32px; background-color: var(--card-bg); }
        .upload-btn { background-color: var(--primary-color); color: white; border: none; padding: 12px 24px; border-radius: 6px; font-size: 14px; cursor: pointer; display: inline-block; font-weight: 500; transition: background-color 0.3s; }
        #upload-info { font-size: 13px; color: var(--text-light); margin-top: 16px; line-height: 1.5; min-height: 20px; }
        .generate-btn { width: 200px; padding: 14px; font-size: 16px; font-weight: 500; border-radius: 6px; margin-top: 20px; }

        /* Step 1: Analysis Page */
        .analysis-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 24px; }
        .analysis-card, .analysis-summary { background-color: var(--card-bg); border: 1px solid var(--border-color); border-radius: 8px; padding: 20px; }
        .analysis-card-title { color: var(--text-light); margin-bottom: 8px; }
        .analysis-card-content { font-size: 16px; font-weight: 500; }
        .analysis-card-content textarea { box-sizing: border-box; width: 100%; min-height: 100px; border: 1px solid #ccc; border-radius: 4px; padding: 8px; font-size: 14px; font-family: var(--font-family); resize: vertical; }
        .analysis-summary { grid-column: 1 / -1; }
        .analysis-details { background-color: var(--card-bg); border: 1px solid var(--border-color); border-radius: 8px; padding: 20px; margin-top: 20px; }
        .analysis-details h3 { margin-top: 0; }
        .analysis-details p, .analysis-details li { line-height: 1.7; }
        .analysis-details textarea { box-sizing: border-box; width: 100%; min-height: 150px; border: 1px solid #ccc; border-radius: 4px; padding: 8px; font-size: 14px; font-family: var(--font-family); resize: vertical; }
        .full-width-card { grid-column: 1 / -1; }

        /* Step 2: Form Page */
        .multi-form-container { display: flex; gap: 24px; height: calc(100vh - 180px); }
        .form-nav { width: 280px; flex-shrink: 0; background-color: var(--card-bg); border: 1px solid var(--border-color); border-radius: 8px; display: flex; flex-direction: column; }
        .form-nav-header { padding: 12px; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; }
        .form-nav-header button { background: none; border: none; color: var(--primary-color); cursor: pointer; font-size: 14px; padding: 4px; }
        .form-nav-list { overflow-y: auto; flex-grow: 1; padding: 8px; }
        .form-nav-item { display: flex; align-items: center; padding: 12px; border-radius: 6px; cursor: pointer; }
        .form-nav-item:hover { background-color: #f0f0f0; }
        .form-nav-item.active { background-color: #eaf1fd; }
        .form-nav-item input[type="checkbox"] { margin-right: 12px; min-width: 16px; height: 16px; cursor: pointer; }
        .form-nav-item-label { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .form-display-area { flex-grow: 1; overflow-y: auto; }
        .form-container { background-color: var(--card-bg); border: 1px solid var(--border-color); border-radius: 8px; padding: 24px; }
        .form-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; }
        .form-header h3 { margin: 0; font-size: 20px; font-weight: 600; }
        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 24px; }
        .form-group { display: flex; flex-direction: column; }
        .form-group.full-width { grid-column: 1 / -1; }
        .form-group label { margin-bottom: 8px; font-weight: 500; }
        .form-group input, .form-group textarea { padding: 10px; border: 1px solid #ccc; border-radius: 4px; font-size: 14px; font-family: var(--font-family); }
        .form-group input:disabled, .form-group textarea:disabled { background-color: #f9f9f9; color: #777; cursor: not-allowed; }
        .form-group textarea { min-height: 120px; resize: vertical; }
        .form-actions { grid-column: 1 / -1; text-align: left; margin-top: 32px; }
        .form-actions .submit-btn { background-color: var(--primary-color); color: white; border: none; padding: 12px 28px; border-radius: 6px; font-size: 16px; cursor: pointer; transition: background-color 0.3s; }
        .form-actions .submit-btn:hover { background-color: #205ac8; }
        .hidden { display: none !important; }

        /* Modal Styles */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.6); display: flex; justify-content: center; align-items: center; z-index: 1000; }
        .modal-container { background-color: white; border-radius: 8px; padding: 0; max-width: 600px; width: 90%; max-height: 80vh; display: flex; flex-direction: column; }
        .modal-header { padding: 16px 24px; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; }
        .modal-header h3 { margin: 0; font-size: 18px; font-weight: 600; }
        .modal-close { background: none; border: none; font-size: 24px; cursor: pointer; color: var(--text-light); }
        .modal-content { padding: 24px; overflow-y: auto; }
        .modal-project-list { max-height: 300px; overflow-y: auto; border: 1px solid var(--border-color); border-radius: 4px; }
        .modal-project-item { display: flex; align-items: center; padding: 12px; border-bottom: 1px solid var(--border-color); }
        .modal-project-item:last-child { border-bottom: none; }
        .modal-project-info h4 { margin: 0; font-size: 14px; font-weight: 500; }
        .modal-footer { padding: 16px 24px; border-top: 1px solid var(--border-color); display: flex; justify-content: flex-end; gap: 12px; margin-top: auto; }
        .modal-footer button { padding: 10px 20px; border-radius: 6px; font-size: 14px; cursor: pointer; font-weight: 500; }
        .modal-cancel { background: white; border: 1px solid var(--border-color); color: var(--text-color); }
        .modal-confirm { background: var(--primary-color); border: none; color: white; }
        .modal-cancel:hover { background-color: #f0f0f0; }
        .modal-confirm:hover:not(:disabled) { background-color: #205ac8; }
        .modal-confirm:disabled { background-color: #b0c4de; cursor: not-allowed; }
        .modal-export-formats { margin-top: 16px; display: flex; gap: 12px; justify-content: center; }
        
        /* Login Modal Styles */
        .login-modal .modal-container { max-width: 450px; }
        .login-form { display: flex; flex-direction: column; gap: 16px; }
        .login-form-group { display: flex; flex-direction: column; }
        .login-form-group label { margin-bottom: 6px; font-weight: 500; color: var(--text-color); }
        .login-form-group input { padding: 12px; border: 1px solid var(--border-color); border-radius: 6px; font-size: 14px; }
        .login-form-group input:focus { outline: none; border-color: var(--primary-color); box-shadow: 0 0 0 2px rgba(42, 110, 227, 0.1); }
        .login-system-info { background-color: #f8f9fa; padding: 16px; border-radius: 6px; margin-bottom: 20px; }
        .login-system-info h4 { margin: 0 0 8px 0; color: var(--primary-color); font-size: 16px; }
        .login-system-info p { margin: 0; color: var(--text-light); font-size: 14px; line-height: 1.5; }
        .login-btn { background-color: var(--primary-color); color: white; border: none; padding: 12px 24px; border-radius: 6px; font-size: 14px; cursor: pointer; font-weight: 500; transition: background-color 0.3s; }
        .login-btn:hover:not(:disabled) { background-color: #205ac8; }
        .login-btn:disabled { background-color: #b0c4de; cursor: not-allowed; }
        .login-status { margin-top: 16px; padding: 12px; border-radius: 6px; text-align: center; font-size: 14px; }
        .login-status.success { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .login-status.error { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .login-status.loading { background-color: #e7f3ff; color: var(--primary-color); border: 1px solid #bee5eb; }
        
        /* Image Upload Styles */
        .image-upload-section { margin-top: 20px; }
        .image-upload-area { border: 2px dashed var(--border-color); border-radius: 8px; padding: 20px; text-align: center; background-color: #fafafa; transition: all 0.3s; }
        .image-upload-area:hover { border-color: var(--primary-color); background-color: #f0f8ff; }
        .image-upload-area.dragover { border-color: var(--primary-color); background-color: #e6f3ff; }
        .image-upload-btn { background-color: var(--primary-color); color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; font-size: 13px; }
        .image-upload-btn:hover { background-color: #205ac8; }
        
        /* Image Links List Styles */
        .image-links-list { margin-top: 16px; padding: 0; border: 1px solid var(--border-color); border-radius: 6px; background-color: white; max-height: 200px; overflow-y: auto; }
        .image-link-item { display: flex; align-items: center; justify-content: space-between; padding: 12px 16px; border-bottom: 1px solid #f0f0f0; transition: background-color 0.3s; }
        .image-link-item:last-child { border-bottom: none; }
        .image-link-item:hover { background-color: #f8f9fa; }
        .image-link-content { flex: 1; display: flex; align-items: center; gap: 12px; }
        .image-link-preview { color: var(--primary-color); text-decoration: none; font-size: 14px; cursor: pointer; transition: all 0.3s; }
        .image-link-preview:hover { text-decoration: underline; color: #205ac8; }
        .image-source-badge { font-size: 10px; padding: 2px 6px; border-radius: 3px; color: white; }
        .image-source-badge.knowledge-base { background-color: rgba(42, 110, 227, 0.9); }
        .image-source-badge.uploaded { background-color: rgba(40, 167, 69, 0.9); }
        .image-link-actions { display: flex; gap: 8px; }
        .image-link-actions button { background: none; border: none; padding: 4px 8px; border-radius: 3px; font-size: 12px; cursor: pointer; transition: all 0.3s; }
        .image-remove-link-btn { color: #dc3545; background-color: rgba(220, 53, 69, 0.1); }
        .image-remove-link-btn:hover { background-color: rgba(220, 53, 69, 0.2); }
        .empty-image-message { padding: 16px; text-align: center; color: var(--text-light); font-size: 14px; }
        .image-preview-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 12px; margin-top: 16px; }
        .image-preview-item { position: relative; border: 1px solid var(--border-color); border-radius: 6px; overflow: hidden; background-color: white; cursor: pointer; transition: all 0.3s; }
        .image-preview-item:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
        .image-preview-item img { width: 100%; height: 80px; object-fit: cover; }
        .image-preview-item .image-name { padding: 8px; font-size: 12px; color: var(--text-color); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .image-preview-item .image-source { position: absolute; top: 4px; left: 4px; background-color: rgba(0, 0, 0, 0.7); color: white; padding: 2px 6px; border-radius: 3px; font-size: 10px; }
        .image-preview-item .image-source.knowledge-base { background-color: rgba(42, 110, 227, 0.9); }
        .image-preview-item .image-source.uploaded { background-color: rgba(40, 167, 69, 0.9); }
        .image-remove-btn { position: absolute; top: 4px; right: 4px; background-color: rgba(255, 0, 0, 0.8); color: white; border: none; border-radius: 50%; width: 20px; height: 20px; cursor: pointer; font-size: 12px; display: flex; align-items: center; justify-content: center; }
        .image-remove-btn:hover { background-color: rgba(255, 0, 0, 1); }
        .image-upload-input { display: none; }
        
        /* Image Preview Modal Styles */
        .image-preview-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.9); display: flex; justify-content: center; align-items: center; z-index: 1001; }
        .image-preview-modal-content { max-width: 90%; max-height: 90%; position: relative; }
        .image-preview-modal img { max-width: 100%; max-height: 100%; object-fit: contain; }
        .image-preview-modal-close { position: absolute; top: -40px; right: 0; background: none; border: none; color: white; font-size: 30px; cursor: pointer; }
        .image-preview-modal-info { position: absolute; bottom: -60px; left: 0; right: 0; color: white; text-align: center; }
        .image-preview-modal-info h4 { margin: 0 0 5px 0; font-size: 16px; }
        .image-preview-modal-info p { margin: 0; font-size: 14px; opacity: 0.8; }
        
        /* Loading Spinner */
        .loading-spinner { display: inline-block; width: 16px; height: 16px; border: 2px solid #f3f3f3; border-top: 2px solid var(--primary-color); border-radius: 50%; animation: spin 1s linear infinite; margin-right: 8px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .btn-loading { opacity: 0.7; cursor: not-allowed; }
        .btn-loading:hover { background-color: var(--primary-color) !important; }
        
        /* Custom Modal Styles */
        .custom-modal-overlay { 
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            background-color: rgba(0, 0, 0, 0.5); 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            z-index: 1002; 
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        .custom-modal-overlay.show { 
            opacity: 1; 
            visibility: visible; 
        }
        
        .custom-modal-container { 
            background-color: white; 
            border-radius: 8px; 
            padding: 0; 
            max-width: 500px; 
            width: 90%; 
            max-height: 80vh; 
            display: flex; 
            flex-direction: column; 
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            transform: translateY(-20px);
            transition: transform 0.3s ease;
        }
        .custom-modal-overlay.show .custom-modal-container {
            transform: translateY(0);
        }
        
        .custom-modal-header { 
            padding: 20px 24px 16px; 
            border-bottom: 1px solid var(--border-color); 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
        }
        .custom-modal-header h3 { 
            margin: 0; 
            font-size: 18px; 
            font-weight: 600; 
            color: var(--text-color);
        }
        .custom-modal-close { 
            background: none; 
            border: none; 
            font-size: 24px; 
            cursor: pointer; 
            color: var(--text-light); 
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: background-color 0.3s, color 0.3s;
        }
        .custom-modal-close:hover {
            background-color: #f0f0f0;
            color: var(--text-color);
        }
        
        .custom-modal-body { 
            padding: 24px; 
            overflow-y: auto; 
            flex: 1;
        }
        .custom-modal-body p { 
            margin: 0 0 16px; 
            line-height: 1.6; 
            color: var(--text-color);
        }
        .custom-modal-body p:last-child { 
            margin-bottom: 0; 
        }
        
        .custom-modal-footer { 
            padding: 16px 24px; 
            border-top: 1px solid var(--border-color); 
            display: flex; 
            justify-content: flex-end; 
            gap: 12px; 
        }
        .custom-modal-footer button { 
            padding: 10px 20px; 
            border-radius: 6px; 
            font-size: 14px; 
            cursor: pointer; 
            font-weight: 500; 
            transition: all 0.3s;
        }
        .custom-modal-btn-cancel { 
            background: white; 
            border: 1px solid var(--border-color); 
            color: var(--text-color); 
        }
        .custom-modal-btn-cancel:hover { 
            background-color: #f0f0f0; 
        }
        .custom-modal-btn-confirm { 
            background: var(--primary-color); 
            border: none; 
            color: white; 
        }
        .custom-modal-btn-confirm:hover:not(:disabled) { 
            background-color: #205ac8; 
        }
        .custom-modal-btn-confirm:disabled { 
            background-color: #b0c4de; 
            cursor: not-allowed; 
        }
        
    </style>
</head>
<body>

<div class="app-container">
    <aside class="sidebar">
        <div class="sidebar-header">
            <img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjQiIGhlaWdodD0iMjQiIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHBhdGggZD0iTTUgMTJIMTNNMyAxOEwxMyAxOE0zIDZMMTggNk0xMyAxMkwyMCAxOU0xMyAxMkwyMCA1IiBzdHJva2U9IiMyYTZlZTMiIHN0cm9rZS13aWR0aD0iMiIgc3Ryb2tlLWxpbmVjYXA9InJvdW5kIiBzdHJva2UtbGluZWpvaW49InJvdW5kIi8+Cjwvc3ZnPgo=" alt="logo">
            <span>Jarvis é¹°çœ¼</span>
        </div>
        <div class="sidebar-content">
            <button class="new-analysis-btn" onclick="app.startNewAnalysis()">+ æ–°å»ºåˆ†æ</button>
            <div class="history-list">
                <h3>å†å²è®°å½•</h3>
                <ul id="history-list-ul"></ul>
            </div>
        </div>
    </aside>

    <main class="main-content">
        <input type="file" id="tender-upload" class="hidden" multiple>
        <div id="breadcrumb-container" class="breadcrumb-container"></div>

        <!-- STEP 0: UPLOAD PAGE -->
        <div id="page-0" class="page">
            <div class="upload-page-container">
                <h1>æ‹›æ ‡åˆ†æåŠ©æ‰‹</h1>
                <p>åˆ©ç”¨AIæ™ºèƒ½åˆ†ææ‹›æ ‡æ–‡ä»¶ï¼Œé«˜æ•ˆäº†è§£æ‹›æ ‡éœ€æ±‚ï¼Œç²¾å‡†åŒ¹é…è¿‡å¾€é¡¹ç›®ç»éªŒã€‚</p>
                <div class="upload-box">
                    <button class="upload-btn" onclick="document.getElementById('tender-upload').click()">+ é€‰æ‹©æ‹›æ ‡æ–‡ä»¶</button>
                    <div id="upload-info">æ”¯æŒ PDF, DOCX, TXT ç­‰æ ¼å¼</div>
                </div>
                <button id="generate-report-btn" class="action-btn generate-btn" onclick="app.generateReport()" disabled>ç”Ÿæˆåˆ†ææŠ¥å‘Š</button>
            </div>
        </div>

        <!-- STEP 1: ANALYSIS PAGE -->
        <div id="page-1" class="page">
            <div class="page-header">
                <div class="header-title-toolbar">
                    <h1>åˆ†æç»“æœ</h1>
                    <div class="toolbar" id="analysis-toolbar"></div>
                </div>
                <div class="header-actions">
                    <button id="generate-forms-btn" class="action-btn" onclick="app.generateForms()">ä¸€é”®ç”Ÿæˆé¡¹ç›®æŠ¥å‘Šè¡¨å•</button>
                </div>
            </div>
            <div id="analysis-content-area"></div>
        </div>

        <!-- STEP 2: MULTI-FORM PAGE -->
        <div id="page-2" class="page">
            <div class="page-header">
                <h1>æœ€ç»ˆé¡¹ç›®æŠ¥å‘Šè¡¨å•</h1>
                <div class="header-actions">
                    <button id="export-btn" class="action-btn" onclick="app.showExportModal()" disabled>å¯¼å‡ºé¡¹ç›®</button>
                </div>
            </div>
            <div class="multi-form-container">
                <nav class="form-nav">
                    <div class="form-nav-header">
                        <button onclick="app.selectAllFormItems(true)">å…¨é€‰</button>
                        <button onclick="app.selectAllFormItems(false)">æ¸…é™¤</button>
                    </div>
                    <div class="form-nav-list" id="form-nav-list"></div>
                </nav>
                <div class="form-display-area" id="form-display-area"></div>
            </div>
        </div>
    </main>
</div>

<!-- Export Modal -->
<div id="export-modal" class="modal-overlay hidden">
    <div class="modal-container">
        <div class="modal-header">
            <h3>å¯¼å‡ºå·²é€‰é¡¹ç›®</h3>
            <button class="modal-close" onclick="app.closeExportModal()">&times;</button>
        </div>
        <div class="modal-content">
            <p>å°†å¯¼å‡ºä»¥ä¸‹ <strong id="export-count"></strong> ä¸ªå·²é€‰é¡¹ç›®ï¼š</p>
            <div class="modal-project-list" id="export-project-list"></div>
            <div class="modal-export-formats">
                <button class="action-btn" onclick="app.confirmExport('PDF')">å¯¼å‡ºä¸º PDF</button>
                <button class="action-btn" onclick="app.confirmExport('DOCX')">å¯¼å‡ºä¸º DOCX</button>
            </div>
        </div>
        <div class="modal-footer">
            <button class="modal-cancel" onclick="app.closeExportModal()">å–æ¶ˆ</button>
        </div>
    </div>
</div>

<!-- Login Modal -->
<div id="login-modal" class="modal-overlay login-modal hidden">
    <div class="modal-container">
        <div class="modal-header">
            <h3>ç™»å½• DWSS ç³»ç»Ÿ</h3>
            <button class="modal-close" onclick="app.closeLoginModal()">&times;</button>
        </div>
        <div class="modal-content">
            <div class="login-system-info">
                <h4>ğŸ” ç³»ç»Ÿç™»å½•</h4>
                <p>éœ€è¦ç™»å½•åˆ°DWSSå¹³å°æ¥è·å–æœ€æ–°çš„é¡¹ç›®æ•°æ®å’Œç”ŸæˆæŠ¥å‘Šè¡¨å•ã€‚</p>
            </div>
            <div id="login-status" class="login-status hidden"></div>
        </div>
        <div class="modal-footer">
            <button class="modal-cancel" onclick="app.closeLoginModal()">å–æ¶ˆ</button>
            <button id="login-submit-btn" class="login-btn" onclick="app.handleAutoLogin()">ç™»å½•</button>
        </div>
    </div>
</div>

<!-- Image Preview Modal -->
<div id="image-preview-modal" class="image-preview-modal hidden">
    <div class="image-preview-modal-content">
        <button class="image-preview-modal-close" onclick="app.closeImagePreviewModal()">&times;</button>
        <img id="image-preview-modal-img" src="" alt="">
        <div class="image-preview-modal-info">
            <h4 id="image-preview-modal-title"></h4>
            <p id="image-preview-modal-details"></p>
        </div>
    </div>
</div>

<!-- Custom Modal -->
<div id="custom-modal" class="custom-modal-overlay">
    <div class="custom-modal-container">
        <div class="custom-modal-header">
            <h3 id="custom-modal-title">æç¤º</h3>
            <button class="custom-modal-close" onclick="app.closeCustomModal()">&times;</button>
        </div>
        <div class="custom-modal-body">
            <div id="custom-modal-message">
                <p id="custom-modal-text"></p>
            </div>
        </div>
        <div class="custom-modal-footer">
            <button id="custom-modal-cancel-btn" class="custom-modal-btn-cancel" onclick="app.closeCustomModal()" style="display: none;">å–æ¶ˆ</button>
            <button id="custom-modal-confirm-btn" class="custom-modal-btn-confirm" onclick="app.confirmCustomModal()">ç¡®å®š</button>
        </div>
    </div>
</div>


<script>
// --- NAMESPACED APPLICATION LOGIC ---
const app = {
    // --- STATE MANAGEMENT ---
    database: {
        projects: [
            { id: 1, title: 'SHENZHEN METRO LINE 4 (PHASE 2)', type: 'TRANSIT-ORIENTED DEVELOPMENTS', year: '2012', country: 'CHINA', city: 'SHENZHEN', developer: 'MTR Corporation Ltd.', gfa: '626,880 sqm', siteArea: '240,029 sqm', involvement: 'Property Development Planning Study, Conceptual Masterplanning', description: 'Line 4 Phase 2 of the Shenzhen Metro is a 16 km long mass transit line with ten stations and associated property development, predominantly in the Longhua Extension Area. Our scope of services includes the urban planning at four of the development sites which will accommodate a range of residential, commercial and institutional properties above or adjacent to the stations.', img: 'https://storage.googleapis.com/gemini-prod/images/4ed1c110-3949-43c2-b342-991590e8d0d5' },
            { id: 2, title: 'TIN SHUI WAI TOWN LOT NO. 23 DEVELOPMENT', type: 'TRANSIT-ORIENTED DEVELOPMENTS', year: '2024', country: 'CHINA', city: 'HONG KONG', developer: 'Sun Hung Kai Properties Ltd.', gfa: '91,256 sqm', siteArea: '18,232 sqm', involvement: 'Project Architect, Design Architect', description: 'The proposed property development at TSWTL 23 is above Tin Wing Light Rail Transit Terminus. The project includes three 38-storey residential buildings with commercial spaces, a clubhouse and a car park.', img: 'https://storage.googleapis.com/gemini-prod/images/3257da41-11ec-45f8-b4b6-39149495acb6' },
            { id: 3, title: 'METRO TOWN', type: 'TRANSIT-ORIENTED DEVELOPMENTS', year: '2007', country: 'CHINA', city: 'HONG KONG', developer: 'Cheung Kong (Holdings) Ltd.', gfa: '236,965 sqm', siteArea: '32,334 sqm', involvement: 'Project Architect, Design Architect', description: 'Metrotown is a residential complex built on top of an existing public transport interchange next to Tiu Keng Leng MTR Station. It consists of nine 50-58-storey towers with a total of 3,772 units.', img: 'https://storage.googleapis.com/gemini-prod/images/8a68b584-6997-40b5-a01c-6d9b93226a45' },
            { id: 4, title: 'POLY HUCHONG STATION MIXED-USE DEVELOPMENT', type: 'TRANSIT-ORIENTED DEVELOPMENTS', year: 'In Progress', country: 'CHINA', city: 'FOSHAN', developer: 'Poly Huanan Industry Company Ltd', gfa: '700,845 sqm', siteArea: '172,909 sqm', involvement: 'Masterplanner, Design Architect', description: 'The project is located on the southwest of Chanxi New City. To the north is Huchong Station of Foshan Metro Line 2. The location has good connection to inter-city transportation and enjoys a convenient traffic network.', img: 'https://storage.googleapis.com/gemini-prod/images/73b3793f-cbbd-4171-be17-10659343cd2b' }
        ],
        analysisTasks: new Map([
            ['task-1', { 
                id: 'task-1', 
                tenderTitle: 'æ­¦æ±‰ç†å·¥å¤§å­¦åŸºå»ºã€ç»´ä¿®...',
                analysisResult: {
                    title: 'æ­¦æ±‰ç†å·¥å¤§å­¦åŸºå»ºã€ç»´ä¿®ã€è®¾å¤‡é‡‡è´­é¢†åŸŸå…¨è¿‡ç¨‹ç®¡ç†å¹³å°é‡‡è´­é¡¹ç›®',
                    client: 'æ­¦æ±‰ç†å·¥å¤§å­¦',
                    packageCount: '1',
                    validPeriod: 'yyyy-mm-dd(èµ·å§‹æ—¥æœŸ) - yyyy-mm-dd(ç»“æŸæ—¥æœŸ) æ ¹æ®æ‹›æ ‡æ–‡ä»¶å†…å®¹: - æäº¤æŠ•æ ‡æ–‡ä»¶æˆªæ­¢æ—¶é—´: 2024å¹´9æœˆ29æ—¥...',
                    budget: '990000å…ƒ (äººæ°‘å¸)',
                    deadline: '2024-09-29',
                    agency: 'æ¹–åŒ—äº˜é¸¿ä¿¡è¯šå’¨è¯¢æœ‰é™å…¬å¸',
                    summary: 'æœ¬æ¬¡æ‹›æ ‡é¡¹ç›®ä¸ºæ­¦æ±‰ç†å·¥å¤§å­¦åŸºå»ºã€ç»´ä¿®ã€è®¾å¤‡é‡‡è´­é¢†åŸŸå…¨è¿‡ç¨‹ç®¡ç†å¹³å°çš„ä¾›è´§ã€å¼€å‘ã€è°ƒè¯•ã€éªŒæ”¶åŠå”®åæœåŠ¡ã€‚é¢„ç®—é‡‘é¢ä¸º99ä¸‡å…ƒï¼Œæœ€é«˜é™ä»·ç›¸åŒã€‚é¡¹ç›®è¦æ±‚æä¾›å›½äº§å›¾å½¢å¼•æ“æ”¯æŒBIMå¯è§†åŒ–ååŒç®¡ç†ï¼Œå¹¶å®ç°ä¸æ ¡å›­CIMæ•°æ®åº•åº§é›†æˆã€‚æŠ€æœ¯æ¡†æ¶åŒ…æ‹¬æ¨¡å—åŒ–å¾®æœåŠ¡æ¶æ„ï¼Œæ”¯æŒç§æœ‰äº‘éƒ¨ç½²ï¼Œå¹¶å…·å¤‡å¼€æ”¾APIæ¥å£èƒ½åŠ›ã€‚',
                    details: '<h3>äºŒã€ä¸»è¦åŠŸèƒ½è¦æ±‚</h3><ul><li><strong>å¯è§†åŒ–é©¾é©¶èˆ±</strong>: å®ç°åŸºå»ºã€ç»´ä¿®ã€è®¾å¤‡é‡‡è´­é¡¹ç›®ä»ç«‹é¡¹ç”³è¯·åˆ°éªŒæ”¶é˜¶æ®µçš„ä¸€ç«™å¼æµç¨‹åŒ–ã€å¯è§†åŒ–æ•°å­—åŒ–ç®¡ç†ã€‚æä¾›é¡¹ç›®æ€»è§ˆã€è¿›åº¦ç›‘æ§ã€èµ„é‡‘ç®¡æ§ç­‰æ ¸å¿ƒåŠŸèƒ½æ¨¡å—ã€‚</li><li><strong>BIMå¯è§†åŒ–ååŒç®¡ç†</strong>: æ”¯æŒBIMæ¨¡å‹åœ¨çº¿è½»é‡åŒ–æµè§ˆï¼Œå¤šä¸“ä¸šå•ä½“æ¨¡å‹åœ¨çº¿æ•´åˆã€‚å®ç°æ¨¡å‹æ‰¹æ³¨ã€ç‰ˆæœ¬ç®¡ç†ã€ååŒè¯„å®¡ç­‰åŠŸèƒ½ã€‚</li><li><strong>å…¨è¿‡ç¨‹ç®¡ç†å¹³å°</strong>: æ¶µç›–é¡¹ç›®ç«‹é¡¹ã€è®¾è®¡ç®¡ç†ã€é‡‡è´­ç®¡ç†ã€æ–½å·¥ç®¡ç†ã€éªŒæ”¶ç®¡ç†å…¨æµç¨‹ï¼Œæ”¯æŒå¤šè§’è‰²ååŒå·¥ä½œã€‚</li><li><strong>æ•°æ®é›†æˆä¸åˆ†æ</strong>: ä¸æ ¡å›­CIMæ•°æ®åº•åº§æ·±åº¦é›†æˆï¼Œæä¾›æ•°æ®å¯è§†åŒ–åˆ†æã€æŠ¥è¡¨ç”Ÿæˆã€å†³ç­–æ”¯æŒç­‰åŠŸèƒ½ã€‚</li></ul><h3>ä¸‰ã€æŠ€æœ¯è¦æ±‚</h3><ul><li><strong>ç³»ç»Ÿæ¶æ„</strong>: é‡‡ç”¨å¾®æœåŠ¡æ¶æ„è®¾è®¡ï¼Œæ”¯æŒæ¨¡å—åŒ–éƒ¨ç½²å’Œæ¨ªå‘æ‰©å±•</li><li><strong>å›¾å½¢å¼•æ“</strong>: å¿…é¡»é‡‡ç”¨å›½äº§å›¾å½¢å¼•æ“ï¼Œæ”¯æŒWebGLæ¸²æŸ“å’Œç§»åŠ¨ç«¯é€‚é…</li><li><strong>éƒ¨ç½²æ–¹å¼</strong>: æ”¯æŒç§æœ‰äº‘éƒ¨ç½²ï¼Œæä¾›å®Œæ•´çš„è¿ç»´ç®¡ç†å·¥å…·</li><li><strong>æ¥å£æ ‡å‡†</strong>: æä¾›æ ‡å‡†REST APIæ¥å£ï¼Œæ”¯æŒç¬¬ä¸‰æ–¹ç³»ç»Ÿé›†æˆ</li></ul>'
                },
                importedProjectIds: new Set(),
                editedFormsData: new Map()
            }],
            ['task-2', { 
                id: 'task-2', 
                tenderTitle: 'é¦™æ¸¯æˆ¿å±‹å§”å‘˜ä¼šè®¾è®¡ã€ä¾›åº”...',
                analysisResult: {
                    title: 'é¦™æ¸¯æˆ¿å±‹å§”å‘˜ä¼šè®¾è®¡ã€ä¾›åº”ã€å®‰è£…å’Œç»´ä¿®ä¿å…»å‡é™æœº',
                    client: 'é¦™æ¸¯æˆ¿å±‹å§”å‘˜ä¼š',
                    packageCount: '3',
                    validPeriod: '2024-12-01 - 2027-11-30 (3å¹´æœåŠ¡æœŸ)',
                    budget: 'HK$128,000,000 (æ¸¯å¸)',
                    deadline: '2025-01-15',
                    agency: 'é¦™æ¸¯æ”¿åºœç‰©æµæœåŠ¡ç½²',
                    summary: 'ä¸ºé¦™æ¸¯å„å…¬å…±å±‹é‚¨çš„å‡é™æœºæä¾›å…¨é¢çš„è®¾è®¡ã€ä¾›åº”ã€å®‰è£…åŠåç»­çš„ç»´ä¿®ä¿å…»æœåŠ¡ã€‚é¡¹ç›®è¦æ±‚æŠ•æ ‡äººå…·å¤‡ä¸°å¯Œçš„å‚ç›´è¿è¾“ç³»ç»Ÿé¡¹ç›®ç»éªŒï¼Œå¹¶èƒ½æä¾›é«˜æ•ˆã€å®‰å…¨ã€å¯é çš„è§£å†³æ–¹æ¡ˆã€‚æœåŠ¡èŒƒå›´è¦†ç›–å…¨æ¸¯çº¦180ä¸ªå…¬å…±å±‹é‚¨ï¼Œæ¶‰åŠè¶…è¿‡8000å°å‡é™æœºè®¾å¤‡çš„ç»´æŠ¤ç®¡ç†ã€‚',
                    details: '<h3>äºŒã€æœåŠ¡èŒƒå›´</h3><ul><li><strong>æ–°å®‰è£…å‡é™æœº</strong>: çº¦200å°æ–°å‡é™æœºçš„è®¾è®¡ã€ä¾›åº”å’Œå®‰è£…</li><li><strong>ç°æœ‰è®¾å¤‡ç»´æŠ¤</strong>: å…¨æ¸¯å…¬å…±å±‹é‚¨ç°æœ‰å‡é™æœºçš„å®šæœŸä¿å…»å’Œç´§æ€¥ç»´ä¿®</li><li><strong>ç°ä»£åŒ–æ”¹é€ </strong>: è€æ—§å‡é™æœºçš„æŠ€æœ¯å‡çº§å’Œå®‰å…¨æ”¹é€ </li><li><strong>24å°æ—¶åº”æ€¥æœåŠ¡</strong>: æä¾›å…¨å¹´æ— ä¼‘çš„æ•…éšœå“åº”å’Œç»´ä¿®æœåŠ¡</li></ul><h3>ä¸‰ã€æŠ€æœ¯è¦æ±‚</h3><ul><li><strong>å®‰å…¨æ ‡å‡†</strong>: å‡é™æœºç³»ç»Ÿéœ€ç¬¦åˆæœ€æ–°çš„å›½é™…å®‰å…¨æ ‡å‡†(ISO 25745, EN 81ç³»åˆ—)</li><li><strong>æ™ºèƒ½ç›‘æ§</strong>: éœ€æä¾›æ™ºèƒ½ç›‘æ§ç³»ç»Ÿï¼Œå®ç°è¿œç¨‹æ•…éšœè¯Šæ–­å’Œé¢„é˜²æ€§ç»´æŠ¤</li><li><strong>èŠ‚èƒ½è¦æ±‚</strong>: æ–°å®‰è£…è®¾å¤‡éœ€è¾¾åˆ°Açº§èƒ½æ•ˆæ ‡å‡†ï¼Œå‡å°‘20%ä»¥ä¸Šèƒ½è€—</li><li><strong>æ— éšœç¢è®¾è®¡</strong>: å…¨é¢ç¬¦åˆã€Šæ®‹ç–¾æ­§è§†æ¡ä¾‹ã€‹è¦æ±‚ï¼Œæä¾›å®Œå–„çš„æ— éšœç¢é€šè¡ŒåŠŸèƒ½</li></ul><h3>å››ã€æœåŠ¡æ°´å¹³è¦æ±‚</h3><ul><li><strong>å“åº”æ—¶é—´</strong>: ç´§æ€¥æ•…éšœ2å°æ—¶å†…åˆ°åœºï¼Œä¸€èˆ¬ç»´ä¿®24å°æ—¶å†…å¤„ç†</li><li><strong>å¯ç”¨ç‡</strong>: å‡é™æœºç³»ç»Ÿå¹´å¯ç”¨ç‡ä¸ä½äº99.5%</li><li><strong>äººå‘˜èµ„è´¨</strong>: ç»´ä¿®æŠ€å¸ˆéœ€æŒæœ‰ç›¸å…³ä¸“ä¸šè¯ä¹¦å’Œå®‰å…¨åŸ¹è®­åˆæ ¼è¯</li></ul>'
                },
                importedProjectIds: new Set(),
                editedFormsData: new Map()
            }]
        ])
    },
    
    currentState: {
        activeTaskId: 'task-1',
        currentStep: 1,
        analysisEditMode: false,
        formExportSelection: new Set(),
        currentEditingFormId: null,
    },

    // --- INITIALIZATION ---
    init() {
        document.getElementById('tender-upload').addEventListener('change', this.handleFileSelect.bind(this));
        
        window.addEventListener('click', (e) => {
            document.querySelectorAll('.dropdown-menu').forEach(menu => {
                const parentButton = menu.previousElementSibling;
                if (parentButton && !parentButton.contains(e.target) && !menu.classList.contains('hidden')) {
                    menu.classList.add('hidden');
                }
            });
        });

        // Add keyboard support for modals
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                if (this.customModalState.isOpen) {
                    this.closeCustomModal();
                }
            }
        });

        // Prevent modal from closing when clicking inside the modal container
        document.getElementById('custom-modal').addEventListener('click', (e) => {
            if (e.target === e.currentTarget) {
                this.closeCustomModal();
            }
        });

        this.renderHistoryList();
        this.loadStateForTask('task-1');
    },

    // --- RENDER & UI UPDATE FUNCTIONS ---
    renderHistoryList() {
        const ul = document.getElementById('history-list-ul');
        ul.innerHTML = '';
        this.database.analysisTasks.forEach(task => {
            const li = document.createElement('li');
            li.id = `history-${task.id}`;
            li.textContent = task.tenderTitle;
            li.onclick = () => this.loadStateForTask(task.id);
            ul.appendChild(li);
        });
        this.updateActiveHistoryItem();
    },

    updateActiveHistoryItem() {
        document.querySelectorAll('#history-list-ul li').forEach(li => {
            li.classList.toggle('active', li.id === `history-${this.currentState.activeTaskId}`);
        });
    },

    updateBreadcrumb() {
        const container = document.getElementById('breadcrumb-container');
        let html = '';
        const base = `<a href="#" class="breadcrumb-item" onclick="app.goToStep(1)">åˆ†æç»“æœ</a>`;
        switch (this.currentState.currentStep) {
            case 2:
                html = `${base} <span class="breadcrumb-separator">&gt;</span> <span class="breadcrumb-item active">è¡¨å•ç¼–è¾‘</span>`;
                break;
            default:
                html = '';
        }
        container.innerHTML = html;
    },

    // --- CORE LOGIC & FLOW CONTROL ---
    loadStateForTask(taskId) {
        this.currentState.activeTaskId = taskId;
        this.currentState.analysisEditMode = false; // Reset edit mode on task switch
        this.currentState.formExportSelection.clear(); // Reset export selection
        this.updateActiveHistoryItem();
        this.goToStep(1);
    },

    goToStep(stepNumber) {
        this.currentState.currentStep = stepNumber;
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        document.getElementById(`page-${stepNumber}`).classList.add('active');
        this.updateBreadcrumb();

        switch(stepNumber) {
            case 1: this.renderAnalysisPage(); break;
            case 2: this.renderMultiFormPage(); break;
        }
    },

    startNewAnalysis() {
        this.showAlert("æ­¤ä¸ºåŸå‹åŠŸèƒ½æ¼”ç¤ºã€‚å°†åˆ›å»ºä¸€ä¸ªæ–°çš„åˆ†æä»»åŠ¡ã€‚", "æ–°å»ºåˆ†æ", "info").then(() => {
            this.currentState.activeTaskId = null;
            this.updateActiveHistoryItem();
            this.goToStep(0);
            document.getElementById('upload-info').textContent = 'æ”¯æŒ PDF, DOCX, TXT ç­‰æ ¼å¼';
            document.getElementById('generate-report-btn').disabled = true;
        });
    },

    handleFileSelect(event) {
        const files = event.target.files;
        if (files.length > 0) {
            let fileNames = Array.from(files).map(f => f.name).join(', ');
            document.getElementById('upload-info').innerHTML = `å·²é€‰æ‹©: <span style="color: var(--primary-color); font-weight: 500;">${fileNames}</span>`;
            document.getElementById('generate-report-btn').disabled = false;
        }
    },

    generateReport() {
        this.showAlert("æ­£åœ¨æ¨¡æ‹ŸAIåˆ†æå¹¶ç”ŸæˆæŠ¥å‘Š...", "ç”ŸæˆæŠ¥å‘Š", "info").then(() => {
            setTimeout(() => {
                this.loadStateForTask('task-1');
            }, 1000);
        });
    },

    // --- STEP 1: ANALYSIS PAGE LOGIC ---
    renderAnalysisPage() {
        const task = this.database.analysisTasks.get(this.currentState.activeTaskId);
        if (!task) return;
        const result = task.analysisResult;
        const editMode = this.currentState.analysisEditMode;

        // Render Toolbar
        const toolbar = document.getElementById('analysis-toolbar');
        toolbar.innerHTML = `
            <a onclick="app.showAlert('æ­£åœ¨åˆ·æ–°åˆ†æç»“æœ...', 'åˆ·æ–°', 'info')">åˆ·æ–°</a>
            <div style="position: relative;">
                <a onclick="this.nextElementSibling.classList.toggle('hidden')">å¯¼å‡ºæ–‡ä»¶</a>
                <div class="dropdown-menu hidden">
                    <a href="#" onclick="app.exportAnalysisFile('PDF')">å¯¼å‡ºä¸º PDF</a>
                    <a href="#" onclick="app.exportAnalysisFile('DOCX')">å¯¼å‡ºä¸º DOCX</a>
                    <a href="#" onclick="app.exportAnalysisFile('MD')">å¯¼å‡ºä¸º MD</a>
                </div>
            </div>
            <a id="analysis-edit-btn" onclick="app.toggleAnalysisEdit(true)">ç¼–è¾‘</a>
            <a id="analysis-save-btn" onclick="app.saveAnalysis()" class="hidden">ä¿å­˜åˆ†æ</a>
        `;
        
        // Render Content
        const container = document.getElementById('analysis-content-area');
        container.innerHTML = `
            <div class="analysis-grid">
                <div class="analysis-card"><div class="analysis-card-title">ğŸ“„ æ‹›æ ‡æ ‡é¢˜</div><div class="analysis-card-content">${result.title}</div></div>
                <div class="analysis-card"><div class="analysis-card-title">ğŸ¢ æ‹›æ ‡å•ä½</div><div class="analysis-card-content">${result.client}</div></div>
                <div class="analysis-card"><div class="analysis-card-title">ğŸ“¦ é‡‡è´­åŒ…æ•°é‡</div><div class="analysis-card-content">${result.packageCount}</div></div>
                <div class="analysis-card"><div class="analysis-card-title">ğŸ›ï¸ ä»£ç†æœºæ„</div><div class="analysis-card-content">${result.agency}</div></div>
                <div class="analysis-card"><div class="analysis-card-title">ğŸ’° é¢„ç®—</div><div class="analysis-card-content">${result.budget}</div></div>
                <div class="analysis-card"><div class="analysis-card-title">â° æˆªæ­¢æ—¥æœŸ</div><div class="analysis-card-content">${result.deadline}</div></div>
                <div class="analysis-card full-width-card"><div class="analysis-card-title">â³ æœ‰æ•ˆæœŸ</div><div class="analysis-card-content">${result.validPeriod}</div></div>
                <div class="analysis-summary">
                    <div class="analysis-card-title">ğŸ“‹ æ‹›æ ‡æ‘˜è¦</div>
                    <div class="analysis-card-content" id="analysis-summary-content">
                        ${editMode ? `<textarea id="summary-textarea">${result.summary}</textarea>` : result.summary}
                    </div>
                </div>
            </div>
            <div class="analysis-details">
                <div class="analysis-card-title">ğŸ“ æ‹›æ ‡è¯¦æƒ…</div>
                <div id="analysis-details-content">
                    ${editMode ? `<textarea id="details-textarea">${result.details}</textarea>` : result.details}
                </div>
            </div>
        `;
        
        // **FIXED**: Directly manage button visibility here to break the recursive loop.
        document.getElementById('analysis-edit-btn').classList.toggle('hidden', editMode);
        document.getElementById('analysis-save-btn').classList.toggle('hidden', !editMode);
    },

    toggleAnalysisEdit(enable) {
        this.currentState.analysisEditMode = enable;
        // **FIXED**: This function now ONLY sets state and triggers a re-render.
        this.renderAnalysisPage();
    },

    saveAnalysis() {
        const task = this.database.analysisTasks.get(this.currentState.activeTaskId);
        if (!task) return;

        const newSummary = document.getElementById('summary-textarea').value;
        const newDetails = document.getElementById('details-textarea').value;

        task.analysisResult.summary = newSummary;
        task.analysisResult.details = newDetails;
        
        this.showAlert("åˆ†æç»“æœå·²æˆåŠŸä¿å­˜ï¼", "ä¿å­˜æˆåŠŸ", "success").then(() => {
            this.toggleAnalysisEdit(false);
        });
    },
    
    exportAnalysisFile(format) {
        this.showAlert(`æ­£åœ¨å¯¼å‡ºåˆ†æç»“æœä¸º ${format} æ ¼å¼... (æ­¤ä¸ºåŸå‹åŠŸèƒ½æ¼”ç¤º)`, "å¯¼å‡ºåˆ†æ", "info").then(() => {
            document.querySelector('#analysis-toolbar .dropdown-menu').classList.add('hidden');
        });
    },

    generateForms() {
        const task = this.database.analysisTasks.get(this.currentState.activeTaskId);
        if (!task) return;

        // Show login modal first
        this.showLoginModal();
    },
    
    showLoginModal() {
        document.getElementById('login-modal').classList.remove('hidden');
        // Reset login status
        const loginStatus = document.getElementById('login-status');
        loginStatus.classList.add('hidden');
        loginStatus.innerHTML = '';
        
        // Reset login button
        const loginBtn = document.getElementById('login-submit-btn');
        loginBtn.innerHTML = 'ç™»å½•';
        loginBtn.disabled = false;
    },
    
    closeLoginModal() {
        document.getElementById('login-modal').classList.add('hidden');
    },
    
    handleAutoLogin() {
        const loginStatus = document.getElementById('login-status');
        const loginBtn = document.getElementById('login-submit-btn');
        
        // Disable login button and show loading
        loginBtn.innerHTML = '<span class="loading-spinner"></span>ç™»å½•ä¸­...';
        loginBtn.disabled = true;
        
        // Step 1: Connecting
        loginStatus.innerHTML = '<span class="loading-spinner"></span>æ­£åœ¨è¿æ¥ DWSS ç³»ç»Ÿ...';
        loginStatus.className = 'login-status loading';
        loginStatus.classList.remove('hidden');
        
        setTimeout(() => {
            // Step 2: Success
            loginStatus.innerHTML = 'âœ“ ç™»å½•æˆåŠŸï¼æ­£åœ¨è·å–é¡¹ç›®æ•°æ®...';
            loginStatus.className = 'login-status success';
            
            setTimeout(() => {
                this.closeLoginModal();
                this.proceedWithFormGeneration();
            }, 500);
        }, 500);
    },
    
    showLoginStatus(message, type) {
        const statusDiv = document.getElementById('login-status');
        statusDiv.textContent = message;
        statusDiv.className = `login-status ${type}`;
        statusDiv.classList.remove('hidden');
    },
    
    proceedWithFormGeneration() {
        const task = this.database.analysisTasks.get(this.currentState.activeTaskId);
        if (!task) return;

        // Show loading state on the generate button
        const btn = document.getElementById('generate-forms-btn');
        const originalText = btn.innerHTML;
        btn.innerHTML = '<span class="loading-spinner"></span>æ­£åœ¨åˆ†æåŒ¹é…é¡¹ç›®...';
        btn.classList.add('btn-loading');
        btn.disabled = true;
        
        const autoSelectedProjectIds = new Set([1, 2, 3, 4]); 

        task.importedProjectIds = autoSelectedProjectIds;
        task.editedFormsData.clear();
        task.importedProjectIds.forEach(id => {
            const projectData = this.database.projects.find(p => p.id === id);
            if (projectData) {
                // Initialize with knowledge base image as thumbnail if available
                const initialThumbnail = projectData.img ? {
                    id: `kb-${id}`,
                    name: 'çŸ¥è¯†åº“ä¸»å›¾',
                    url: projectData.img,
                    source: 'knowledge-base',
                    size: 0,
                    isKnowledgeBase: true
                } : null;
                
                task.editedFormsData.set(id, { 
                    ...projectData, 
                    thumbnail: initialThumbnail,
                    referenceImages: []
                });
            }
        });
        
        setTimeout(() => {
             // Reset button state
             btn.innerHTML = originalText;
             btn.classList.remove('btn-loading');
             btn.disabled = false;
             
             this.goToStep(2);
        }, 2000);
    },

    // --- STEP 2: MULTI-FORM PAGE LOGIC ---
    renderMultiFormPage() {
        const task = this.database.analysisTasks.get(this.currentState.activeTaskId);
        this.updateExportButtonState();

        if (!task || task.importedProjectIds.size === 0) {
            document.getElementById('form-nav-list').innerHTML = '<div style="padding: 12px; color: var(--text-light);">æ— å·²ç”Ÿæˆçš„é¡¹ç›®è¡¨å•ã€‚</div>';
            document.getElementById('form-display-area').innerHTML = '<div class="placeholder" style="height: 100%; display: flex; align-items: center; justify-content: center; text-align: center; color: var(--text-light);"><h3>è¯·å…ˆè¿”å›åˆ†æç»“æœé¡µé¢ï¼Œ<br>ç‚¹å‡»â€œä¸€é”®ç”Ÿæˆé¡¹ç›®æŠ¥å‘Šè¡¨å•â€ã€‚</h3></div>';
            return;
        }

        const formNavList = document.getElementById('form-nav-list');
        formNavList.innerHTML = '';
        task.importedProjectIds.forEach(projectId => {
            const projectData = task.editedFormsData.get(projectId);
            if (projectData) {
                const isChecked = this.currentState.formExportSelection.has(projectId);
                const navItem = document.createElement('div');
                navItem.className = 'form-nav-item';
                navItem.id = `form-nav-item-${projectId}`;
                navItem.innerHTML = `
                    <input type="checkbox" id="form-check-${projectId}" onchange="event.stopPropagation(); app.toggleFormExportSelection(${projectId})" onclick="event.stopPropagation()" ${isChecked ? 'checked' : ''}>
                    <span class="form-nav-item-label">${projectData.title}</span>
                `;
                navItem.onclick = () => this.displayProjectForm(projectId);
                formNavList.appendChild(navItem);
            }
        });

        if (this.currentState.currentEditingFormId && task.importedProjectIds.has(this.currentState.currentEditingFormId)) {
            this.displayProjectForm(this.currentState.currentEditingFormId);
        } else {
            const firstProjectId = task.importedProjectIds.values().next().value;
            this.displayProjectForm(firstProjectId);
        }
    },

    displayProjectForm(projectId) {
        this.currentState.currentEditingFormId = projectId;
        const task = this.database.analysisTasks.get(this.currentState.activeTaskId);
        const projectData = task.editedFormsData.get(projectId);
        if (!projectData) return;

        document.querySelectorAll('.form-nav-item').forEach(item => item.classList.remove('active'));
        document.getElementById(`form-nav-item-${projectId}`).classList.add('active');

        const formArea = document.getElementById('form-display-area');
        formArea.innerHTML = `
            <div class="form-container">
                <div class="form-header">
                    <h3 id="form-header-title">${projectData.title}</h3>
                    <button id="edit-btn" class="action-btn" onclick="app.toggleFormEdit(true)">ç¼–è¾‘</button>
                </div>
                <form id="project-form" onsubmit="app.submitForm(event)">
                    <div class="form-grid">
                        <div class="form-group full-width"><label for="p-title">é¡¹ç›®æ ‡é¢˜</label><input type="text" id="p-title" value="${projectData.title}" disabled></div>
                        <div class="form-group"><label for="p-country">å›½å®¶/åœ°åŒº</label><input type="text" id="p-country" value="${projectData.country}" disabled></div>
                        <div class="form-group"><label for="p-city">åŸå¸‚</label><input type="text" id="p-city" value="${projectData.city}" disabled></div>
                        <div class="form-group"><label for="p-year">ç«£å·¥å¹´ä»½</label><input type="text" id="p-year" value="${projectData.year}" disabled></div>
                        <div class="form-group"><label for="p-developer">å‘å±•å•†</label><input type="text" id="p-developer" value="${projectData.developer}" disabled></div>
                        <div class="form-group"><label for="p-gfa">å»ºç­‘é¢ç§¯</label><input type="text" id="p-gfa" value="${projectData.gfa}" disabled></div>
                        <div class="form-group"><label for="p-site-area">ç”¨åœ°é¢ç§¯</label><input type="text" id="p-site-area" value="${projectData.siteArea}" disabled></div>
                        <div class="form-group full-width"><label for="p-involvement">æœåŠ¡èŒƒå›´</label><textarea id="p-involvement" disabled>${projectData.involvement}</textarea></div>
                        <div class="form-group full-width"><label for="p-description">é¡¹ç›®æè¿°</label><textarea id="p-description" disabled>${projectData.description}</textarea></div>
                        <div class="form-group full-width">
                            <label>é¡¹ç›®ä¸»å›¾ (Project Thumbnail)</label>
                            <div class="image-upload-section">
                                <div class="image-upload-area" id="thumbnail-upload-area-${projectId}" ondrop="app.handleThumbnailDrop(event, ${projectId})" ondragover="app.handleImageDragOver(event)" ondragleave="app.handleImageDragLeave(event)">
                                    <input type="file" id="thumbnail-upload-input-${projectId}" class="image-upload-input" accept="image/*" onchange="app.handleThumbnailSelect(event, ${projectId})">
                                    <button type="button" class="image-upload-btn" onclick="document.getElementById('thumbnail-upload-input-${projectId}').click()" disabled id="thumbnail-upload-btn-${projectId}">+ ä¸Šä¼ é¡¹ç›®ä¸»å›¾</button>
                                    <div style="margin-top: 8px; font-size: 12px; color: var(--text-light);">æ”¯æŒ JPG, PNG, GIF æ ¼å¼ï¼Œåªèƒ½ä¸Šä¼ ä¸€å¼ å›¾ç‰‡ï¼Œæœ€å¤§ 5MB</div>
                                </div>
                                <div class="image-links-list" id="thumbnail-links-list-${projectId}"></div>
                                <div class="image-error-message" id="thumbnail-error-${projectId}" style="display: none; color: #dc3545; font-size: 12px; margin-top: 8px;"></div>
                            </div>
                        </div>
                        <div class="form-group full-width">
                            <label>é¡¹ç›®å‚è€ƒå›¾ç‰‡ (Reference Images)</label>
                            <div class="image-upload-section">
                                <div class="image-upload-area" id="reference-upload-area-${projectId}" ondrop="app.handleReferenceImageDrop(event, ${projectId})" ondragover="app.handleImageDragOver(event)" ondragleave="app.handleImageDragLeave(event)">
                                    <input type="file" id="reference-upload-input-${projectId}" class="image-upload-input" multiple accept="image/*" onchange="app.handleReferenceImageSelect(event, ${projectId})">
                                    <button type="button" class="image-upload-btn" onclick="document.getElementById('reference-upload-input-${projectId}').click()" disabled id="reference-upload-btn-${projectId}">+ æ·»åŠ å‚è€ƒå›¾ç‰‡</button>
                                    <div style="margin-top: 8px; font-size: 12px; color: var(--text-light);">æ”¯æŒ JPG, PNG, GIF æ ¼å¼ï¼Œæœ€å¤šä¸Šä¼  8 å¼ å›¾ç‰‡ï¼Œæ¯å¼ æœ€å¤§ 5MB</div>
                                </div>
                                <div class="image-links-list" id="reference-links-list-${projectId}"></div>
                                <div class="image-error-message" id="reference-error-${projectId}" style="display: none; color: #dc3545; font-size: 12px; margin-top: 8px;"></div>
                            </div>
                        </div>
                        <div id="save-btn-container" class="form-actions hidden"><button type="submit" class="submit-btn">ä¿å­˜æ›´æ”¹</button></div>
                    </div>
                </form>
            </div>
        `;
        
        // Initialize image links lists after form is rendered
        setTimeout(() => {
            this.updateThumbnailList(projectId);
            this.updateReferenceImagesList(projectId);
        }, 100);
    },

    toggleFormEdit(isEditable) {
        const formElements = document.querySelectorAll('#project-form input, #project-form textarea');
        formElements.forEach(el => el.disabled = !isEditable);
        document.getElementById('edit-btn').classList.toggle('hidden', isEditable);
        document.getElementById('save-btn-container').classList.toggle('hidden', !isEditable);
        
        // Enable/disable image upload buttons
        const currentId = this.currentState.currentEditingFormId;
        const thumbnailBtn = document.getElementById(`thumbnail-upload-btn-${currentId}`);
        const referenceBtn = document.getElementById(`reference-upload-btn-${currentId}`);
        if (thumbnailBtn) {
            thumbnailBtn.disabled = !isEditable;
        }
        if (referenceBtn) {
            referenceBtn.disabled = !isEditable;
        }
    },

    submitForm(event) {
        event.preventDefault();
        const currentId = this.currentState.currentEditingFormId;
        const task = this.database.analysisTasks.get(this.currentState.activeTaskId);
        if (!task || currentId === null) return;

        const currentData = task.editedFormsData.get(currentId);
        currentData.title = document.getElementById('p-title').value;
        currentData.country = document.getElementById('p-country').value;
        currentData.city = document.getElementById('p-city').value;
        currentData.year = document.getElementById('p-year').value;
        currentData.developer = document.getElementById('p-developer').value;
        currentData.gfa = document.getElementById('p-gfa').value;
        currentData.siteArea = document.getElementById('p-site-area').value;
        currentData.involvement = document.getElementById('p-involvement').value;
        currentData.description = document.getElementById('p-description').value;
        
        // Images are already saved in currentData.images during upload
        
        document.querySelector(`#form-nav-item-${currentId} .form-nav-item-label`).textContent = currentData.title;
        document.getElementById('form-header-title').textContent = currentData.title;

        this.showAlert(`é¡¹ç›® "${currentData.title}" çš„æ›´æ”¹å·²åœ¨Jarvisçš„â€œå·¥ä½œå¿«ç…§â€ä¸­ä¿å­˜æˆåŠŸï¼`);
        this.toggleFormEdit(false);
    },

    // --- EXPORT LOGIC ---
    toggleFormExportSelection(projectId) {
        const checkbox = document.getElementById(`form-check-${projectId}`);
        if (checkbox.checked) {
            this.currentState.formExportSelection.add(projectId);
        } else {
            this.currentState.formExportSelection.delete(projectId);
        }
        this.updateExportButtonState();
    },

    selectAllFormItems(select) {
        const task = this.database.analysisTasks.get(this.currentState.activeTaskId);
        if (!task) return;
        
        task.importedProjectIds.forEach(id => {
            const checkbox = document.getElementById(`form-check-${id}`);
            if (checkbox) checkbox.checked = select;
            if (select) {
                this.currentState.formExportSelection.add(id);
            } else {
                this.currentState.formExportSelection.delete(id);
            }
        });
        this.updateExportButtonState();
    },

    updateExportButtonState() {
        const exportBtn = document.getElementById('export-btn');
        if (exportBtn) {
            exportBtn.disabled = this.currentState.formExportSelection.size === 0;
        }
    },

    showExportModal() {
        const selection = this.currentState.formExportSelection;
        const task = this.database.analysisTasks.get(this.currentState.activeTaskId);
        if (selection.size === 0 || !task) return;

        document.getElementById('export-count').textContent = selection.size;
        const listContainer = document.getElementById('export-project-list');
        listContainer.innerHTML = '';
        selection.forEach(id => {
            const project = task.editedFormsData.get(id);
            if (project) {
                const item = document.createElement('div');
                item.className = 'modal-project-item';
                item.innerHTML = `<div class="modal-project-info"><h4>${project.title}</h4></div>`;
                listContainer.appendChild(item);
            }
        });
        document.getElementById('export-modal').classList.remove('hidden');
    },

    closeExportModal() {
        document.getElementById('export-modal').classList.add('hidden');
    },

    confirmExport(format) {
        const count = this.currentState.formExportSelection.size;
        this.showAlert(`æ­£åœ¨å°† ${count} ä¸ªå·²é€‰é¡¹ç›®çš„æœ€ç»ˆæ•°æ®åˆå¹¶å¯¼å‡ºä¸º ${format} æ ¼å¼...\n(æ­¤ä¸ºåŸå‹åŠŸèƒ½æ¼”ç¤º)`, "å¯¼å‡ºé¡¹ç›®", "info").then(() => {
            this.closeExportModal();
        });
    },
    
    // --- IMAGE UPLOAD FUNCTIONALITY ---
    handleImageDragOver(event) {
        event.preventDefault();
        event.currentTarget.classList.add('dragover');
    },
    
    handleImageDragLeave(event) {
        event.currentTarget.classList.remove('dragover');
    },
    
    // Thumbnail handlers
    handleThumbnailDrop(event, projectId) {
        event.preventDefault();
        event.currentTarget.classList.remove('dragover');
        const files = event.dataTransfer.files;
        this.processThumbnailFiles(files, projectId);
    },
    
    handleThumbnailSelect(event, projectId) {
        const files = event.target.files;
        this.processThumbnailFiles(files, projectId);
    },
    
    // Reference image handlers
    handleReferenceImageDrop(event, projectId) {
        event.preventDefault();
        event.currentTarget.classList.remove('dragover');
        const files = event.dataTransfer.files;
        this.processReferenceImageFiles(files, projectId);
    },
    
    handleReferenceImageSelect(event, projectId) {
        const files = event.target.files;
        this.processReferenceImageFiles(files, projectId);
    },
    
    async processThumbnailFiles(files, projectId) {
        const task = this.database.analysisTasks.get(this.currentState.activeTaskId);
        const projectData = task.editedFormsData.get(projectId);
        if (!projectData) return;
        
        this.clearError('thumbnail', projectId);
        
        if (files.length === 0) return;
        
        // æ£€æŸ¥ä¸Šä¼ æ•°é‡é™åˆ¶
        if (!this.checkUploadLimits(files, projectId, 'thumbnail')) {
            return;
        }
        
        // Only process the first file for thumbnail
        const file = files[0];
        
        // åŸºç¡€æ–‡ä»¶éªŒè¯
        if (!this.validateImageFile(file, projectId, 'thumbnail')) {
            return;
        }
        
        // æ£€æŸ¥å›¾ç‰‡å°ºå¯¸
        const dimensionResult = await this.validateImageDimensions(file);
        if (!dimensionResult.isValid) {
            this.showError('thumbnail', projectId, dimensionResult.errorMessage);
            return;
        }
        
        const reader = new FileReader();
        reader.onload = (e) => {
            const imageData = {
                id: Date.now() + Math.random(),
                name: file.name,
                url: e.target.result,
                source: 'uploaded',
                size: file.size,
                isKnowledgeBase: false
            };
            projectData.thumbnail = imageData;
            this.updateThumbnailList(projectId);
        };
        reader.readAsDataURL(file);
    },
    
    async processReferenceImageFiles(files, projectId) {
        const task = this.database.analysisTasks.get(this.currentState.activeTaskId);
        const projectData = task.editedFormsData.get(projectId);
        if (!projectData) return;
        
        this.clearError('reference', projectId);
        
        if (!projectData.referenceImages) {
            projectData.referenceImages = [];
        }
        
        // æ£€æŸ¥ä¸Šä¼ æ•°é‡é™åˆ¶
        if (!this.checkUploadLimits(files, projectId, 'reference')) {
            return;
        }
        
        // å¤„ç†æ¯ä¸ªæ–‡ä»¶
        for (const file of files) {
            if (!file.type.startsWith('image/')) continue;
            
            // åŸºç¡€æ–‡ä»¶éªŒè¯
            if (!this.validateImageFile(file, projectId, 'reference')) {
                continue;
            }
            
            // æ£€æŸ¥å›¾ç‰‡å°ºå¯¸
            const dimensionResult = await this.validateImageDimensions(file);
            if (!dimensionResult.isValid) {
                this.showError('reference', projectId, dimensionResult.errorMessage);
                continue;
            }
            
            // å¤„ç†å›¾ç‰‡
            const reader = new FileReader();
            reader.onload = (e) => {
                const imageData = {
                    id: Date.now() + Math.random(),
                    name: file.name,
                    url: e.target.result,
                    source: 'uploaded',
                    size: file.size,
                    isKnowledgeBase: false
                };
                projectData.referenceImages.push(imageData);
                this.updateReferenceImagesList(projectId);
            };
            reader.readAsDataURL(file);
        }
    },
    
    updateThumbnailList(projectId) {
        const task = this.database.analysisTasks.get(this.currentState.activeTaskId);
        const projectData = task.editedFormsData.get(projectId);
        const linksList = document.getElementById(`thumbnail-links-list-${projectId}`);
        
        if (!projectData || !linksList) return;
        
        linksList.innerHTML = '';
        
        if (!projectData.thumbnail) {
            linksList.innerHTML = '<div class="empty-image-message">æš‚æ— ä¸»å›¾ï¼Œç‚¹å‡»ä¸Šæ–¹æŒ‰é’®ä¸Šä¼ é¡¹ç›®ä¸»å›¾</div>';
            return;
        }
        
        const image = projectData.thumbnail;
        const linkItem = document.createElement('div');
        linkItem.className = 'image-link-item';
        
        const sourceLabel = image.source === 'knowledge-base' ? 'çŸ¥è¯†åº“' : 'ä¸Šä¼ ';
        const sourceClass = image.source === 'knowledge-base' ? 'knowledge-base' : 'uploaded';
        const sizeText = image.size > 0 ? ` (${Math.round(image.size / 1024)}KB)` : '';
        
        linkItem.innerHTML = `
            <div class="image-link-content">
                <span class="image-source-badge ${sourceClass}">${sourceLabel}</span>
                <a href="#" class="image-link-preview" onclick="app.showThumbnailPreview('${image.id}', ${projectId}); return false;">
                    ${image.name}${sizeText}
                </a>
            </div>
            <div class="image-link-actions">
                <button type="button" class="image-remove-link-btn" onclick="app.removeThumbnail(${projectId})" title="åˆ é™¤ä¸»å›¾">åˆ é™¤</button>
            </div>
        `;
        linksList.appendChild(linkItem);
    },
    
    updateReferenceImagesList(projectId) {
        const task = this.database.analysisTasks.get(this.currentState.activeTaskId);
        const projectData = task.editedFormsData.get(projectId);
        const linksList = document.getElementById(`reference-links-list-${projectId}`);
        
        if (!projectData || !linksList) return;
        
        // Initialize referenceImages array if it doesn't exist
        if (!projectData.referenceImages) {
            projectData.referenceImages = [];
        }
        
        linksList.innerHTML = '';
        
        if (projectData.referenceImages.length === 0) {
            linksList.innerHTML = '<div class="empty-image-message">æš‚æ— å‚è€ƒå›¾ç‰‡ï¼Œç‚¹å‡»ä¸Šæ–¹æŒ‰é’®æ·»åŠ å‚è€ƒå›¾ç‰‡</div>';
            return;
        }
        
        projectData.referenceImages.forEach(image => {
            const linkItem = document.createElement('div');
            linkItem.className = 'image-link-item';
            
            const sourceLabel = image.source === 'knowledge-base' ? 'çŸ¥è¯†åº“' : 'ä¸Šä¼ ';
            const sourceClass = image.source === 'knowledge-base' ? 'knowledge-base' : 'uploaded';
            const sizeText = image.size > 0 ? ` (${Math.round(image.size / 1024)}KB)` : '';
            
            linkItem.innerHTML = `
                <div class="image-link-content">
                    <span class="image-source-badge ${sourceClass}">${sourceLabel}</span>
                    <a href="#" class="image-link-preview" onclick="app.showReferenceImagePreview('${image.id}', ${projectId}); return false;">
                        ${image.name}${sizeText}
                    </a>
                </div>
                <div class="image-link-actions">
                    <button type="button" class="image-remove-link-btn" onclick="app.removeReferenceImage(${projectId}, '${image.id}')" title="åˆ é™¤å›¾ç‰‡">åˆ é™¤</button>
                </div>
            `;
            linksList.appendChild(linkItem);
        });
    },
    
    removeThumbnail(projectId) {
        const task = this.database.analysisTasks.get(this.currentState.activeTaskId);
        const projectData = task.editedFormsData.get(projectId);
        if (!projectData || !projectData.thumbnail) return;
        
        const imageName = projectData.thumbnail.name;
        this.showConfirm(
            `ç¡®å®šè¦åˆ é™¤é¡¹ç›®ä¸»å›¾ "${imageName}" å—ï¼Ÿåˆ é™¤åæ— æ³•æ¢å¤ã€‚`,
            'åˆ é™¤ç¡®è®¤',
            'warning'
        ).then((confirmed) => {
            if (confirmed) {
                projectData.thumbnail = null;
                this.updateThumbnailList(projectId);
                this.showAlert('é¡¹ç›®ä¸»å›¾å·²åˆ é™¤', 'åˆ é™¤æˆåŠŸ', 'success');
            }
        }).catch(() => {
            // ç”¨æˆ·å–æ¶ˆåˆ é™¤ï¼Œä¸åšä»»ä½•æ“ä½œ
        });
    },
    
    removeReferenceImage(projectId, imageId) {
        const task = this.database.analysisTasks.get(this.currentState.activeTaskId);
        const projectData = task.editedFormsData.get(projectId);
        if (!projectData || !projectData.referenceImages) return;
        
        // æŸ¥æ‰¾è¦åˆ é™¤çš„å›¾ç‰‡
        const imageToDelete = projectData.referenceImages.find(img => img.id == imageId);
        if (!imageToDelete) return;
        
        this.showConfirm(
            `ç¡®å®šè¦åˆ é™¤å‚è€ƒå›¾ç‰‡ "${imageToDelete.name}" å—ï¼Ÿåˆ é™¤åæ— æ³•æ¢å¤ã€‚`,
            'åˆ é™¤ç¡®è®¤',
            'warning'
        ).then((confirmed) => {
            if (confirmed) {
                projectData.referenceImages = projectData.referenceImages.filter(img => img.id != imageId);
                this.updateReferenceImagesList(projectId);
                this.showAlert('å‚è€ƒå›¾ç‰‡å·²åˆ é™¤', 'åˆ é™¤æˆåŠŸ', 'success');
            }
        }).catch(() => {
            // ç”¨æˆ·å–æ¶ˆåˆ é™¤ï¼Œä¸åšä»»ä½•æ“ä½œ
        });
    },
    
    // --- IMAGE PREVIEW MODAL FUNCTIONALITY ---
    showThumbnailPreview(imageId, projectId) {
        const task = this.database.analysisTasks.get(this.currentState.activeTaskId);
        const projectData = task.editedFormsData.get(projectId);
        if (!projectData || !projectData.thumbnail) return;
        
        const image = projectData.thumbnail;
        if (image.id != imageId) return;
        
        this.displayImagePreview(image, 'é¡¹ç›®ä¸»å›¾');
    },
    
    showReferenceImagePreview(imageId, projectId) {
        const task = this.database.analysisTasks.get(this.currentState.activeTaskId);
        const projectData = task.editedFormsData.get(projectId);
        if (!projectData || !projectData.referenceImages) return;
        
        const image = projectData.referenceImages.find(img => img.id == imageId);
        if (!image) return;
        
        this.displayImagePreview(image, 'å‚è€ƒå›¾ç‰‡');
    },
    
    displayImagePreview(image, imageType) {
        const modal = document.getElementById('image-preview-modal');
        const modalImg = document.getElementById('image-preview-modal-img');
        const modalTitle = document.getElementById('image-preview-modal-title');
        const modalDetails = document.getElementById('image-preview-modal-details');
        
        // ç”Ÿæˆç™½è‰²å‡å›¾ç‰‡ - åˆ›å»ºä¸€ä¸ª Canvas ç»˜åˆ¶ç™½è‰²çŸ©å½¢
        const canvas = document.createElement('canvas');
        canvas.width = 800;
        canvas.height = 600;
        const ctx = canvas.getContext('2d');
        
        // å¡«å……ç™½è‰²èƒŒæ™¯
        ctx.fillStyle = '#ffffff';
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        
        // æ·»åŠ è¾¹æ¡†
        ctx.strokeStyle = '#e0e0e0';
        ctx.lineWidth = 2;
        ctx.strokeRect(1, 1, canvas.width - 2, canvas.height - 2);
        
        // æ·»åŠ æ–‡å­—æç¤º
        ctx.fillStyle = '#999999';
        ctx.font = '24px Arial, sans-serif';
        ctx.textAlign = 'center';
        ctx.fillText('å›¾ç‰‡é¢„è§ˆå ä½å›¾', canvas.width / 2, canvas.height / 2 - 40);
        
        ctx.font = '16px Arial, sans-serif';
        ctx.fillText(`${imageType}: ${image.name}`, canvas.width / 2, canvas.height / 2);
        
        const sourceText = image.source === 'knowledge-base' ? 'çŸ¥è¯†åº“å›¾ç‰‡' : 'ä¸Šä¼ å›¾ç‰‡';
        ctx.fillText(`æ¥æº: ${sourceText}`, canvas.width / 2, canvas.height / 2 + 30);
        
        modalImg.src = canvas.toDataURL();
        modalTitle.textContent = `${image.name} (${imageType}é¢„è§ˆ)`;
        
        const sizeText = image.size > 0 ? ` â€¢ å¤§å°: ${Math.round(image.size / 1024)}KB` : '';
        modalDetails.textContent = `${imageType} â€¢ ${sourceText}${sizeText} â€¢ æ­¤ä¸ºé¢„è§ˆå ä½å›¾`;
        
        modal.classList.remove('hidden');
        
        // Close modal when clicking outside the image
        modal.onclick = (e) => {
            if (e.target === modal) {
                this.closeImagePreviewModal();
            }
        };
    },
    
    closeImagePreviewModal() {
        document.getElementById('image-preview-modal').classList.add('hidden');
    },
    
    
    // --- ERROR HANDLING FUNCTIONS ---
    showError(type, projectId, message) {
        const errorElement = document.getElementById(`${type}-error-${projectId}`);
        if (errorElement) {
            errorElement.textContent = message;
            errorElement.style.display = 'block';
            // Auto-hide error after 5 seconds
            setTimeout(() => {
                this.clearError(type, projectId);
            }, 5000);
        }
    },
    
    clearError(type, projectId) {
        const errorElement = document.getElementById(`${type}-error-${projectId}`);
        if (errorElement) {
            errorElement.style.display = 'none';
            errorElement.textContent = '';
        }
    },
    
    // --- IMAGE VALIDATION ---
    validateImageFile(file, projectId = null, type = null) {
        const allowedTypes = ['image/jpeg', 'image/png', 'image/gif', 'image/webp'];
        const maxSize = 5 * 1024 * 1024; // 5MB
        
        if (!allowedTypes.includes(file.type)) {
            const errorMsg = 'ä¸æ”¯æŒçš„å›¾ç‰‡æ ¼å¼ã€‚è¯·é€‰æ‹© JPGã€PNGã€GIF æˆ– WebP æ ¼å¼çš„å›¾ç‰‡ã€‚';
            if (projectId && type) {
                this.showError(type, projectId, errorMsg);
            } else {
                this.showCustomModal('é”™è¯¯', errorMsg, 'error');
            }
            return false;
        }
        
        if (file.size > maxSize) {
            const errorMsg = 'å›¾ç‰‡æ–‡ä»¶è¿‡å¤§ã€‚è¯·é€‰æ‹©å°äº 5MB çš„å›¾ç‰‡ã€‚';
            if (projectId && type) {
                this.showError(type, projectId, errorMsg);
            } else {
                this.showCustomModal('é”™è¯¯', errorMsg, 'error');
            }
            return false;
        }
        
        return true;
    },
    
    // æ£€æŸ¥å›¾ç‰‡å°ºå¯¸çš„å¼‚æ­¥å‡½æ•°
    validateImageDimensions(file, maxWidth = 4096, maxHeight = 4096) {
        return new Promise((resolve) => {
            const img = new Image();
            img.onload = function() {
                const isValid = this.width <= maxWidth && this.height <= maxHeight;
                resolve({
                    isValid,
                    width: this.width,
                    height: this.height,
                    errorMessage: isValid ? null : `å›¾ç‰‡å°ºå¯¸è¿‡å¤§ï¼ˆ${this.width}Ã—${this.height}ï¼‰ã€‚è¯·é€‰æ‹©å°ºå¯¸å°äº ${maxWidth}Ã—${maxHeight} åƒç´ çš„å›¾ç‰‡ã€‚`
                });
            };
            img.onerror = function() {
                resolve({
                    isValid: false,
                    width: 0,
                    height: 0,
                    errorMessage: 'æ— æ³•è¯»å–å›¾ç‰‡æ–‡ä»¶ï¼Œè¯·é€‰æ‹©æœ‰æ•ˆçš„å›¾ç‰‡ã€‚'
                });
            };
            img.src = URL.createObjectURL(file);
        });
    },
    
    // æ£€æŸ¥ä¸Šä¼ æ•°é‡é™åˆ¶
    checkUploadLimits(files, projectId, type) {
        const task = this.database.analysisTasks.get(this.currentState.activeTaskId);
        const projectData = task.editedFormsData.get(projectId);
        
        if (type === 'thumbnail') {
            if (files.length > 1) {
                this.showError(type, projectId, 'é¡¹ç›®ä¸»å›¾åªèƒ½ä¸Šä¼ ä¸€å¼ å›¾ç‰‡');
                return false;
            }
        } else if (type === 'reference') {
            const maxReferenceImages = 8;
            const currentCount = projectData.referenceImages ? projectData.referenceImages.length : 0;
            const newFilesCount = files.length;
            
            if (currentCount + newFilesCount > maxReferenceImages) {
                this.showError(type, projectId, `å‚è€ƒå›¾ç‰‡æœ€å¤šåªèƒ½ä¸Šä¼  ${maxReferenceImages} å¼ ï¼Œå½“å‰å·²æœ‰ ${currentCount} å¼ ï¼Œæ— æ³•å†æ·»åŠ  ${newFilesCount} å¼ å›¾ç‰‡`);
                return false;
            }
        }
        
        return true;
    },
    
    // --- CUSTOM MODAL FUNCTIONALITY ---
    customModalState: {
        isOpen: false,
        callback: null,
        cancelCallback: null
    },
    
    showCustomModal(title, message, type = 'info', showCancel = false, confirmText = 'ç¡®å®š', cancelText = 'å–æ¶ˆ') {
        return new Promise((resolve, reject) => {
            this.customModalState.isOpen = true;
            this.customModalState.callback = resolve;
            this.customModalState.cancelCallback = reject;
            
            const modal = document.getElementById('custom-modal');
            const titleElement = document.getElementById('custom-modal-title');
            const textElement = document.getElementById('custom-modal-text');
            const confirmBtn = document.getElementById('custom-modal-confirm-btn');
            const cancelBtn = document.getElementById('custom-modal-cancel-btn');
            
            // Set title and message
            titleElement.textContent = title;
            textElement.textContent = message;
            
            // Set button text
            confirmBtn.textContent = confirmText;
            cancelBtn.textContent = cancelText;
            
            // Show/hide cancel button
            cancelBtn.style.display = showCancel ? 'block' : 'none';
            
            // Show modal with animation
            modal.classList.add('show');
            
            // Focus on confirm button
            setTimeout(() => {
                confirmBtn.focus();
            }, 100);
        });
    },
    
    closeCustomModal() {
        if (!this.customModalState.isOpen) return;
        
        const modal = document.getElementById('custom-modal');
        modal.classList.remove('show');
        
        this.customModalState.isOpen = false;
        
        // Call cancel callback if exists
        if (this.customModalState.cancelCallback) {
            this.customModalState.cancelCallback(false);
        }
        
        // Reset callbacks
        this.customModalState.callback = null;
        this.customModalState.cancelCallback = null;
    },
    
    confirmCustomModal() {
        if (!this.customModalState.isOpen) return;
        
        const modal = document.getElementById('custom-modal');
        modal.classList.remove('show');
        
        this.customModalState.isOpen = false;
        
        // Call confirm callback if exists
        if (this.customModalState.callback) {
            this.customModalState.callback(true);
        }
        
        // Reset callbacks
        this.customModalState.callback = null;
        this.customModalState.cancelCallback = null;
    },
    
    // Enhanced alert function that uses custom modal
    showAlert(message, title = 'æç¤º', type = 'info') {
        return this.showCustomModal(title, message, type);
    },
    
    // Enhanced confirm function that uses custom modal
    showConfirm(message, title = 'ç¡®è®¤', type = 'info') {
        return this.showCustomModal(title, message, type, true, 'ç¡®å®š', 'å–æ¶ˆ');
    },
    
    // Test modal function for demonstration
    testModal() {
        const modalTypes = ['info', 'success', 'warning', 'error'];
        const messages = [
            'è¿™æ˜¯ä¸€ä¸ªä¿¡æ¯æç¤ºæ¨¡æ€æ¡†',
            'æ“ä½œæˆåŠŸå®Œæˆï¼',
            'è¯·æ³¨æ„ï¼Œè¿™æ˜¯ä¸€ä¸ªè­¦å‘Šä¿¡æ¯',
            'å‘ç”Ÿäº†é”™è¯¯ï¼Œè¯·æ£€æŸ¥è¾“å…¥'
        ];
        const titles = ['ä¿¡æ¯', 'æˆåŠŸ', 'è­¦å‘Š', 'é”™è¯¯'];
        
        const randomIndex = Math.floor(Math.random() * modalTypes.length);
        this.showAlert(messages[randomIndex], titles[randomIndex], modalTypes[randomIndex]);
    }
};

// --- START THE APP ---
document.addEventListener('DOMContentLoaded', () => {
    app.init();
});
</script>
</body>
</html>
